<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expediente - {{ patient.name }} {{ patient.surname }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f7fa; font-family: Arial, sans-serif; }
    .header-card { background: #fff; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.05); }
    .profile-avatar { width:80px; height:80px; border-radius:50%; background:#007bff; color:#fff; display:flex;align-items:center;justify-content:center;font-size:32px }
    .tabs { margin-top:20px }
    .tab-content-card { background:#fff; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.05); }
    .med-item { border-bottom:1px solid #eef2f6; padding:12px 0 }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="row g-3">
      <div class="col-12 header-card">
        <div class="d-flex align-items-center">
          <div class="profile-avatar me-3">{{ patient.name[0].upper() }}</div>
          <div>
            <h3 class="mb-0">{{ patient.name }} {{ patient.surname }}{% if patient.second_surname %} {{ patient.second_surname }}{% endif %}</h3>
            <div class="text-muted">Expediente: {{ patient.file_number }} • Edad: {{ ( ( (utcnow()|string)|int ) ) }}</div>
            <div class="mt-2 small text-muted">
              <span class="me-3">Genero: {{ patient.gender }}</span>
              <span class="me-3">DUI: {{ patient.dui }}</span>
              <span class="me-3">Nacimiento: {{ patient.birth_date }}</span>
            </div>
          </div>
          <div class="ms-auto text-end">
            <button class="btn btn-outline-primary">Modificar</button>
            <button class="btn btn-primary">Guardar</button>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-3 small text-muted">Tel: {{ patient.phone }}</div>
          <div class="col-md-5 small text-muted">Dirección: {{ patient.address }}, {{ patient.city }}</div>
          <div class="col-md-4 small text-muted text-end">Contacto emergencia: {{ patient.emergency_name }} - {{ patient.emergency_phone }}</div>
        </div>
      </div>

      <div class="col-12">
        <div class="tabs d-flex gap-2">
          <button class="btn btn-light active" data-tab="historial">Historial</button>
          <button class="btn btn-light" data-tab="diagnosticos">Diagnósticos</button>
          <button class="btn btn-light" data-tab="medicamentos">Medicamentos</button>
          <button class="btn btn-light" data-tab="laboratorio">Laboratorio</button>
          <button class="btn btn-light" data-tab="antecedentes">Antecedentes</button>
        </div>
      </div>

      <div class="col-12">
        <div id="historial" class="tab-content-card">
          <h5>Consultas recientes</h5>
          {% if consultations and consultations|length > 0 %}
            <div class="list-group">
              {% for c in consultations %}
                <div class="list-group-item">
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong>{{ c.created_at }}</strong>
                      <div class="text-muted">Diagnóstico: {{ c.diagnostico.principal if c.diagnostico and c.diagnostico.principal else '-' }}</div>
                    </div>
                    <div class="text-end">
                      <a class="btn btn-sm btn-outline-secondary" href="#" onclick="showConsult('{{ c.id }}')">Ver</a>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">No hay consultas registradas</div>
          {% endif %}
        </div>

        <div id="diagnosticos" class="tab-content-card" style="display:none">
          <h5>Diagnósticos</h5>
          {% if consultations and consultations|length > 0 %}
            <ul>
            {% for c in consultations %}
              {% if c.diagnostico and (c.diagnostico.principal or c.diagnostico.secundarios) %}
                <li><strong>{{ c.created_at }}:</strong> {{ c.diagnostico.principal or '' }} {% if c.diagnostico.secundarios %}- {{ c.diagnostico.secundarios }}{% endif %}</li>
              {% endif %}
            {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">Sin diagnósticos registrados</div>
          {% endif %}
        </div>

        <div id="medicamentos" class="tab-content-card" style="display:none">
          <h5>Medicamentos actuales</h5>
          {% if patient.medications %}
            {% for m in patient.medications %}
              <div class="med-item">
                <div><strong>{{ m.name }}</strong></div>
                <div class="text-muted small">{{ m.dose }} • {{ m.instructions }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-muted">No hay medicamentos registrados</div>
          {% endif %}
        </div>

        <div id="laboratorio" class="tab-content-card" style="display:none">
          <h5>Laboratorio</h5>
          {% if consultations and consultations|length > 0 %}
            {% for c in consultations %}
              {% if c.laboratorio and (c.laboratorio.examenes or c.laboratorio.resultados) %}
                <div class="mb-3">
                  <div><strong>{{ c.created_at }}</strong></div>
                  <div class="text-muted small">Exámenes: {{ c.laboratorio.examenes }}</div>
                  <div class="text-muted small">Resultados: {{ c.laboratorio.resultados }}</div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="text-muted">Sin datos de laboratorio</div>
          {% endif %}
        </div>

        <div id="antecedentes" class="tab-content-card" style="display:none">
          <h5>Antecedentes</h5>
          {% if patient.chronic_diseases or patient.allergies %}
            <div class="row">
              <div class="col-md-6">
                <h6>Enfermedades crónicas</h6>
                <ul>
                  {% for d in patient.chronic_diseases or [] %}
                    <li>{{ d }}</li>
                  {% endfor %}
                </ul>
              </div>
              <div class="col-md-6">
                <h6>Alergias</h6>
                <ul>
                  {% for a in patient.allergies or [] %}
                    <li>{{ a }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          {% else %}
            <div class="text-muted">No se encontraron antecedentes</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content-card').forEach(c => c.style.display = 'none');
        btn.classList.add('active');
        const id = btn.getAttribute('data-tab');
        document.getElementById(id).style.display = 'block';
      });
    });

    function showConsult(id) {
      // Simple behavior: scroll to Diagnósticos and highlight matching entry if needed
      document.querySelector('[data-tab="diagnosticos"]').click();
    }
  </script>
</body>
</html>
