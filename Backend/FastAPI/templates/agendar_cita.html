<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendar Cita - Gestión de Clínicas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: #f5f7fb;
        font-family: Arial, sans-serif;
      }

      .sidebar {
        background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
        min-height: 100vh;
        width: 220px;
        position: fixed;
        left: 0;
        top: 0;
        padding-top: 20px;
      }

      .logo {
        text-align: center;
        margin-bottom: 40px;
      }

      .logo img {
        width: 80px;
        height: 80px;
      }

      .sidebar .nav-item {
        margin: 15px 0;
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
      }

      .sidebar .nav-item.active,
      .sidebar .nav-item:hover {
        border-left-color: #3498db;
        background-color: rgba(52, 152, 219, 0.08);
      }

      .sidebar .nav-link {
        color: #ecf0f1;
        padding: 12px 20px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s ease;
      }

      .sidebar .nav-link:hover {
        color: #3498db;
      }

      .sidebar .nav-link i {
        width: 25px;
        text-align: center;
        font-size: 20px;
      }

      .main-content {
        margin-left: 220px;
        padding: 30px;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h2 {
        margin: 0;
        font-size: 28px;
      }

      .search-bar {
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        width: 300px;
      }

      .search-bar input {
        border: none;
        outline: none;
        width: 100%;
      }

      /* appointment page specific */
      .card-speciality {
        cursor: pointer;
        border: 1px solid #e6e6e6;
        border-radius: 10px;
        padding: 18px;
        text-align: center;
        background: white;
      }
      .card-speciality.selected {
        border-color: #667eea;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.15);
      }
      .doctor-card {
        cursor: pointer;
        border: 1px solid #eee;
        padding: 12px;
        border-radius: 8px;
        background: white;
        text-align: center;
      }
      .doctor-card.selected {
        border-color: #3498db;
        box-shadow: 0 2px 6px rgba(52, 152, 219, 0.12);
      }
      .summary {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 100%;
          min-height: auto;
          position: static;
        }
        .main-content {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <img src="{{ url_for('static', path='/img/logosv.jpg') }}" alt="Logo" />
      </div>
      <nav>
        <div class="nav-item">
          <a href="/dashboard" class="nav-link"
            ><i class="fas fa-home"></i><span>Inicio</span></a
          >
        </div>
        <div class="nav-item">
          <a href="/calendario" class="nav-link"
            ><i class="fas fa-calendar-alt"></i><span>Calendario</span></a
          >
        </div>
        <div class="nav-item active">
          <a href="/agendar" class="nav-link"
            ><i class="fas fa-plus-circle"></i><span>Agendar Cita</span></a
          >
        </div>

        <div class="nav-item">
          <a href="/historial" class="nav-link"
            ><i class="fas fa-file-medical"></i><span>Historial Médico</span></a
          >
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div
        class="header"
        style="
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: #fff;
          padding: 20px;
          border-radius: 8px;
          margin-bottom: 20px;
        "
      >
        <h2>Agendar Cita</h2>
        <div>Usuario: {{ patient.name }} {{ patient.surname }}</div>
      </div>

      <div class="row g-3">
        <div class="col-12">
          <h5><i class="fas fa-heartbeat"></i> Seleccionar Especialidad</h5>
          <div id="specialities" class="d-flex flex-wrap gap-3 mt-2"></div>
        </div>

        <div class="col-12">
          <h5><i class="fas fa-user-md"></i> Seleccionar Doctor</h5>
          <div id="doctors" class="d-flex flex-wrap gap-3 mt-2"></div>
        </div>

        <div class="col-md-6">
          <label>Fecha</label>
          <input id="dateInput" class="form-control" type="date" />
        </div>
        <div class="col-md-6">
          <label>Hora</label>
          <input id="timeInput" class="form-control" type="time" />
        </div>

        <div class="col-12">
          <h5>Resumen de la Cita</h5>
          <div class="summary">
            <p>
              <strong>Paciente:</strong> {{ patient.name }} {{ patient.surname
              }}
            </p>
            <p><strong>Doctor:</strong> <span id="summaryDoctor">-</span></p>
            <p>
              <strong>Especialidad:</strong>
              <span id="summarySpeciality">-</span>
            </p>
            <p>
              <strong>Fecha/Hora:</strong> <span id="summaryDatetime">-</span>
            </p>
            <div class="mt-2">
              <button id="submitBtn" class="btn btn-primary">
                Agendar Cita
              </button>
              <a href="/calendario" class="btn btn-link">Ir al Calendario</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let doctors = [];
      let selectedSpeciality = null;
      let selectedDoctor = null;

      async function loadDoctors() {
        const res = await fetch("/doctor/");
        if (!res.ok) return;
        doctors = await res.json();
        renderSpecialities();
        renderDoctors();
      }

      function renderSpecialities() {
        const container = document.getElementById("specialities");
        const set = new Set(doctors.map((d) => d.speciality || "General"));
        container.innerHTML = "";
        Array.from(set).forEach((spec) => {
          const div = document.createElement("div");
          div.className = "card-speciality";
          div.style.minWidth = "160px";
          div.innerHTML = `<i class='fas fa-stethoscope' style='font-size:20px;color:#667eea;display:block;margin-bottom:8px;'></i><div>${spec}</div>`;
          div.onclick = () => {
            selectedSpeciality = spec;
            document
              .querySelectorAll(".card-speciality")
              .forEach((c) => c.classList.remove("selected"));
            div.classList.add("selected");
            renderDoctors();
          };
          container.appendChild(div);
        });
      }

      function renderDoctors() {
        const container = document.getElementById("doctors");
        container.innerHTML = "";
        const list = selectedSpeciality
          ? doctors.filter(
              (d) => (d.speciality || "General") === selectedSpeciality
            )
          : doctors;
        list.forEach((d) => {
          const div = document.createElement("div");
          div.className = "doctor-card";
          div.style.minWidth = "180px";
          div.innerHTML = `<div style='font-weight:bold'>Dr. ${d.name} ${
            d.surname
          }</div><div style='font-size:12px;color:#666'>${
            d.speciality || "General"
          }</div>`;
          div.onclick = () => {
            document
              .querySelectorAll(".doctor-card")
              .forEach((c) => c.classList.remove("selected"));
            div.classList.add("selected");
            selectedDoctor = d;
            updateSummary();
          };
          container.appendChild(div);
        });
      }

      function updateSummary() {
        document.getElementById("summaryDoctor").textContent = selectedDoctor
          ? `Dr. ${selectedDoctor.name} ${selectedDoctor.surname}`
          : "-";
        document.getElementById("summarySpeciality").textContent =
          selectedSpeciality ||
          (selectedDoctor ? selectedDoctor.speciality : "-");
        const date = document.getElementById("dateInput").value;
        const time = document.getElementById("timeInput").value;
        document.getElementById("summaryDatetime").textContent =
          date && time ? `${date} ${time}` : "-";
      }

      document
        .getElementById("dateInput")
        .addEventListener("change", updateSummary);
      document
        .getElementById("timeInput")
        .addEventListener("change", updateSummary);

      document
        .getElementById("submitBtn")
        .addEventListener("click", async () => {
          if (!selectedDoctor) {
            alert("Selecciona un doctor");
            return;
          }
          const date = document.getElementById("dateInput").value;
          const time = document.getElementById("timeInput").value || "09:00";
          if (!date) {
            alert("Selecciona una fecha");
            return;
          }
          // Build ISO datetime
          const iso = `${date}T${time}:00`;
          const payload = {
            patient_name: `{{ patient.name }}`,
            doctor_name: `${selectedDoctor.name} ${selectedDoctor.surname}`,
            date: iso,
            status: "scheduled",
          };
          const res = await fetch("/appointment/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (res.ok) {
            alert("Cita agendada");
            window.location.href = "/calendario";
          } else {
            const err = await res.json();
            alert("Error: " + (err.detail || JSON.stringify(err)));
          }
        });

      loadDoctors();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
